
---------------------------------------------------------------------------------
-- Stored procedure that will  ### Do something
-- Gets: @file_ID int,
-- Returns: @@result varchar(255)
-- Returns: @error int
---------------------------------------------------------------------------------

IF OBJECT_ID('pr_Check_Thesaurus', 'P') IS NOT NULL
DROP PROCEDURE dbo.[pr_Check_Thesaurus];
GO 


CREATE PROCEDURE [dbo].[pr_Check_Thesaurus]
	@file_ID int,
	@result varchar(255) OUTPUT,
	@error int OUTPUT,
	@errorIndexes varchar(max) OUTPUT
AS
SET NOCOUNT ON

DECLARE @SQL_STATEMENT nvarchar(max),
@iErrorCode_exec int,
@TLogMessage_ID int,
@Creator int,
@ObjectType int,
@TempTable_GUID varchar(250),
@ObjectName varchar(100),
@count int

SET @result='ERROR'

BEGIN TRY

	SELECT 
			@Creator= Creator,
			@TempTable_GUID = TempTable_GUID,
			@ObjectName = ObjectName,
			@ObjectType = ObjectType
	FROM [File] 
	WHERE ID = @file_ID

		IF OBJECT_ID('tempdb..#tempIndexError') IS NOT NULL
		DROP TABLE #tempIndexError

	CREATE TABLE #tempIndexError (
	index_ int
	)

		IF OBJECT_ID('tempdb..#temp') IS NOT NULL
		DROP TABLE #temp

  SELECT f.Name AS NameOrigin,
		Options
  INto #temp
  FROM 
	(SELECT COLUMN_NAME
	FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = @TempTable_GUID AND COLUMN_NAME not like 'Station_%' ) t
JOIN 
	(SELECT form.*
	FROM [dbo].[ModuleForms] form
	--JOIN ObservationDynProp dp ON dp.Name = form.Name AND dp.TypeProp = 'Integer' 
	WHERE 
	Module_id = 1 AND TypeObj = @ObjectType
	AND InputType = 'AutocompTreeEditor') f ON t.COLUMN_NAME = f.Name

	SET @SQL_STATEMENT = 'SELECT [index] FROM '+@TempTable_GUID+' tGuid '

	DECLARE @WhereSQL nvarchar(max)
	DECLARE @JoinSQL nvarchar(max)
	SET @WhereSQL = '@'
	SET @JoinSQL = '@'


select  @JoinSQL =  @JoinSQL +'LEFT JOIN THESAURUS.dbo.TTopic D_'+NameOrigin+' on D_'+NameOrigin+'.TTop_PK_ID = '+Options 
+ ' LEFT JOIN THESAURUS.dbo.VTopicCompatibility T_'+NameOrigin+' on 
		((T_'+NameOrigin+'.TTop_NameFr =CONVERT(VARCHAR(250),tGuid.'+NameOrigin+') OR T_'+NameOrigin+'.TTop_NameEn =CONVERT(VARCHAR(250),tGuid.'+NameOrigin+'))
		
		 and T_'+NameOrigin+'.TTop_Type = CASE WHEN D_'+NameOrigin+'.TTop_Type in (''TOP Concept'') 
		THEN D_'+NameOrigin+'.TTop_Name ELSE D_'+NameOrigin+'.TTop_Type END) ',

 @WhereSQL = @WhereSQL + 'OR (CONVERT(VARCHAR(250),tGuid.'+NameOrigin+') IS NOT NULL and NOT EXISTS (Select * 
												from THESAURUS.dbo.VTopicCompatibility T2_'+NameOrigin+' 
												where T2_'+NameOrigin+'.TTop_PK_ID <> T_'+NameOrigin+'.TTop_PK_ID 
												AND  ( ( T2_'+NameOrigin+'.TTop_NameFr = CONVERT(VARCHAR(250),tGuid.'+NameOrigin+') OR T2_'+NameOrigin+'.TTop_NameEn = CONVERT(VARCHAR(250),tGuid.'+NameOrigin+')) 
												and T2_'+NameOrigin+'.TTop_Type = CASE WHEN D_'+NameOrigin+'.TTop_Type = ''TOP Concept'' THEN D_'+NameOrigin+'.TTop_Name ELSE D_'+NameOrigin+'.TTop_Type END 
													)
												)  
							AND T_'+NameOrigin+'.TTop_FullPath IS NULL ) '
FROM #temp

	SET @JoinSQL = REPLACE(@JoinSQL,'@LEFT',' LEFT ')

	SET @WhereSQL = REPLACE(@WhereSQL,'@OR',' WHERE ')
	
	SET @SQL_STATEMENT = @SQL_STATEMENT+@JoinSQL + @WhereSQL


	IF (SELECT COUNT(*) FROM #temp)> 0
	BEGIN
		INSERT INTO #tempIndexError
		EXEC SP_EXECUTESQL @SQL_STATEMENT;
	END 


	IF (SELECT COUNT(*) FROM #tempIndexError) > 0 
		BEGIN 
			SET @error = 1
			SET @errorIndexes = '@'
			SELECT @errorIndexes = @errorIndexes + ', '+CONVERT(VARCHAR(100),index_)
			FROM #tempIndexError
		END

	SET @errorIndexes = REPLACE(@errorIndexes,'@, ','')


END TRY
BEGIN CATCH
	SET @error = ERROR_NUMBER()

	--recording error log
	SET @SQL_STATEMENT = 'INSERT INTO NSLog.dbo.TLOG_MESSAGES ([JCRE]
      ,[LOG_LEVEL]
      ,[ORIGIN]
      ,[SCOPE]
      ,[LOGUSER]
      ,[DOMAINE]
      ,[MESSAGE_NUMBER]
      ,[LOG_MESSAGE]
      ,[OTHERSINFOS])
	  SELECT 
			GETDATE(),
			5,
			''Import excel protocol'',
			''pr_Check_Thesaurus'',
			1,
			3,
			'+CONVERT(VARCHAR(max),@error)+',
			'''+CONVERT(VARCHAR(max),REplace(ERROR_MESSAGE(),'''',''))+''',
			''@file_ID =  ''+CONVERT(VARCHAR,' +CONVERT(VARCHAR,@file_ID)+')'
			
			--SELECT @TLogMessage_ID = SCOPE_IDENTITY()	'				
			
	EXEC SP_EXECUTESQL @SQL_STATEMENT
					
END CATCH;

IF @@ERROR <> 0
	BEGIN
		SET @error = @@ERROR
	END
IF @error <> 0
    BEGIN
		PRINT 'ErrorCode = '+str(@error)
    END
ELSE
    BEGIN
		SET @result = 'OK'
    END
SELECT  @result,  @error, @errorIndexes


GO


INSERT INTO [dbo].[TVersion] (TVer_FileName,TVer_Date,TVer_DbName) VALUES ('122_ImportExcel_pr_Check_Thesaurus',GETDATE(),(SELECT db_name()))


GO
