
---------------------------------------------------------------------------------
-- Stored procedure that will  ### Do something
-- Gets: @file_ID int,
-- Returns: @@result varchar(255)
-- Returns: @error int
---------------------------------------------------------------------------------

IF OBJECT_ID('pr_insertObservations_From_Import', 'P') IS NOT NULL
DROP PROCEDURE dbo.[pr_insertObservations_From_Import];
GO 


CREATE PROCEDURE [dbo].[pr_insertObservations_From_Import] 
	(
	@file_ID int,
	@result varchar(255) OUTPUT,
	@error int OUTPUT,
	@errorfake varchar(255) OUTPUT
	)
AS

BEGIN TRY
	SET NOCOUNT ON;
	DECLARE @SQL_STATEMENT nvarchar(max),
	@SQL nvarchar(max),
	@SQL_1 nvarchar(max),
	@iErrorCode_exec int,
	@TLogMessage_ID int,
	@Creator int,
	@ObjectType varchar(250),
	@TempTable_GUID varchar(250),
	@ObjectName varchar(100),
	@count int
	
	SET @result='ERROR'

		SELECT
			@Creator= Creator,
			@TempTable_GUID = TempTable_GUID,
			@ObjectName = ObjectName,
			@ObjectType = ObjectType
	FROM [File]
	WHERE ID = @file_ID

	BEGIN TRAN
	SET @SQL_1 =''

		EXEC('ALTER TABLE '+@TempTable_GUID+' ADD [FK_Observation] int null;') --pour stocker les id retournées aprés insertion d'observations

		--Recovery columns in station present in import excel table
		DECLARE @col nvarchar(max),
		@colImport nvarchar(max)

		SELECT  @col = COALESCE(@col + ', ', '') +'['+TC1.COLUMN_NAME+']',
		@colImport = COALESCE(@colImport + ', ', '') +'['+TC1.COLUMN_NAME+']'
			FROM INFORMATION_SCHEMA.COLUMNS  [TC1]
			JOIN INFORMATION_SCHEMA.COLUMNS  [TC2]
			ON TC1.COLUMN_NAME = TC2.COLUMN_NAME
			WHERE TC1.TABLE_NAME = 'Observation'
			AND TC2.TABLE_NAME = @TempTable_GUID

		SET @col = @col + ', creationDate, FK_ProtocoleType, original_id'
		SET @colImport = @colImport + ', GETDATE(), '+@ObjectType+' , Station_original_id'
		--insert into observation new observations from exceltab
		SET @SQL_1 = @SQL_1 +'DECLARE @tempListId TABLE (
			[ID] [int]  NOT NULL,
			[ORIGINAL_INDEX] varchar(255) NOT NULL
			)
			INSERT INTO Observation ( '+@col+' )
			OUTPUT Inserted.ID, Inserted.[original_id] AS original_id into @templistId
			SELECT '+@colImport+' 
			FROM '+@TempTable_GUID+';'
		-- get back inserted id in exceltab FK_Observation
		SET @SQL_1 = @SQL_1 +' UPDATE
			'+@TempTable_GUID+'
			SET
			FK_Observation = TMP.ID
			FROM
			@tempListId AS TMP
			WHERE
			[index] = REPLACE(TMP.ORIGINAL_INDEX , '''+@TempTable_GUID+'_'','''');
			'
			EXEC SP_EXECUTESQL @SQL_1;
		-- now insert dyn prop for observation

		DECLARE  @tempDynProp TABLE (excelColName varchar(100),FK_ObservationDynProp int, TypeProp varchar(20) )
		DECLARE @sqlDyn nvarchar(max) 

		SET @sqlDyn = '@'

		INSERT INTO @tempDynProp (excelColName, FK_ObservationDynProp, TypeProp)
		SELECT  tc2.COLUMN_NAME, dp.ID, dp.TypeProp
			FROM INFORMATION_SCHEMA.COLUMNS  [TC2]
			JOIN ObservationDynProp dp ON tc2.COLUMN_NAME = dp.Name
			WHERE TC2.TABLE_NAME = @TempTable_GUID


		SELECT @sqlDyn = @sqlDyn+'UNION ALL SELECT GETDATE(), '
		+CASE WHEN TypeProp =  'Integer' THEN excelColName ELSE 'NULL' END +' AS ValueInt, '
		+CASE  WHEN TypeProp = 'String' THEN excelColName ELSE 'NULL' END +' AS ValueString, '
		+CASE  WHEN TypeProp = 'Float' THEN excelColName ELSE 'NULL' END +' AS ValueFloat, '
		+CASE WHEN TypeProp = 'Date' OR TypeProp = 'Date Only' OR TypeProp = 'Time' THEN excelColName ELSE 'NULL' END +' AS ValueDate, '
		+ CONVERT(VARCHAR,FK_ObservationDynProp)+' AS FK_ObservationDynProp, FK_Observation FROM '+@TempTable_GUID+' '
		FROM @tempDynProp

		SELECT @sqlDyn = REPLACE(@sqlDyn, '@UNION ALL','')

		INSERT INTO ObservationDynPropValue (StartDate,ValueInt, ValueString, ValueFloat, ValueDate, FK_ObservationDynProp, FK_Observation)
		EXEC SP_EXECUTESQL @sqlDyn;

	SET @errorfake = 'nope' 

	IF @@TRANCOUNT > 0 
		COMMIT TRAN

	END TRY
	BEGIN CATCH
		ROLLBACK TRAN
		SET @error = ERROR_NUMBER()

		--recording error log
		SET @SQL_STATEMENT = 'INSERT INTO NSLog.dbo.TLOG_MESSAGES ([JCRE]
		  ,[LOG_LEVEL]
		  ,[ORIGIN]
		  ,[SCOPE]
		  ,[LOGUSER]
		  ,[DOMAINE]
		  ,[MESSAGE_NUMBER]
		  ,[LOG_MESSAGE]
		  ,[OTHERSINFOS])
		  SELECT 
				GETDATE(),
				5,
				''Import excel protocol'',
				''pr_insertObservations_From_Import'',
				1,
				3,
				'+CONVERT(VARCHAR(max),@error)+',
				'''+CONVERT(VARCHAR(max),REplace(ERROR_MESSAGE(),'''',''))+''',
				''@file_ID =  ''+CONVERT(VARCHAR,' +CONVERT(VARCHAR,@file_ID)+')'
			
				--SELECT @TLogMessage_ID = SCOPE_IDENTITY()	'				
			
		EXEC SP_EXECUTESQL @SQL_STATEMENT
					
	END CATCH;

IF @@ERROR <> 0
	BEGIN
		SET @error = @@ERROR
		--suppression des alter table 
		EXEC('ALTER TABLE '+@TempTable_GUID+' DROP COLUMN Fk_observation;')  
	END
IF @error <> 0
    BEGIN
		PRINT 'ErrorCode = '+str(@error)
    END
ELSE
    BEGIN
		SET @result = 'OK'
    END
SELECT  @result,  @error, @errorfake


INSERT INTO [dbo].[TVersion] (TVer_FileName,TVer_Date,TVer_DbName) VALUES ('125_pr_insertObservations_From_Import',GETDATE(),(SELECT db_name()))


GO
